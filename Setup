## Quellen:

## https://docs.voidlinux.org/installation/guides/fde.html
## https://gist.github.com/zen0bit/e246a35eec24756f9aba927f9a83fccc
## https://gist.github.com/gbrlsnchs/9c9dc55cd0beb26e141ee3ea59f26e21
## https://gitlab.com/BreakPointSSC/void-linux-uefi-luks-btrfs/-/blob/main/Void_Linux_Full_Disk_Encryption_KDE.txt
## https://gist.github.com/themagicalmammal/e443d3c5440d566f8206e5b957ab1493
## https://gist.github.com/bastomiadi/abf27618341fc561735adfb17e586916

## Vorbereitung:

sudo wipefs -a /dev/nvme0n1p# /sda
sudo cfdisk /dev/nvme0n1


sudo mkfs.vfat -F32 -n EFI /dev/nvme0n1p5
sudo cryptsetup luksFormat --type=luks2 /dev/nvme0n1p6
sudo cryptsetup luksOpen /dev/nvme0n1p6 void

sudo mkfs.btrfs -L void /dev/mapper/void
sudo BTRFS_OPTS="rw,relatime,compress=zstd,space_cache=v2,discard=async"
sudo mount -o $BTRFS_OPTS /dev/mapper/void /mnt

sudo btrfs su cr /mnt/home

sudo mkdir -p /mnt/home
sudo mount -o $BTRFS_OPTS,subvol=home /dev/mapper/void /mnt/home
sudo mkdir -p /mnt/boot/efi
sudo mkdir -p /mnt/efi
sudo mount /dev/nvme0n1p5 /mnt/efi

sudo mkdir -p /mnt/var
sudo btrfs su cr /mnt/var/cache
sudo btrfs su cr /mnt/var/tmp
sudo btrfs su cr /mnt/var/log
sudo mkdir -p /mnt/var/lib
sudo btrfs su cr /mnt/var/lib/flatpak


sudo mkdir -p /mnt/var/db/xbps/keys
sudo cp /var/db/xbps/keys/* /mnt/var/db/xbps/keys/

sudo xbps-install -S -R https://repo-de.voidlinux.org/current -r /mnt base-system cryptsetup nano xmirror btrfs-progs lz4

su
xchroot /mnt
chown root:root /
chmod 755 /
passwd root
nano /etc/hostname
nano /etc/locale.conf
nano /etc/default/libc-locales
nano /etc/rc.conf
EDITOR=nano visudo
   %wheel ALL=(ALL) ALL

xbps-reconfigure -f glibc-locales

xmirror -s https://repo-de.voidlinux.org/
xbps-install void-repo-nonfree

nano /etc/dracut.conf.d/override.conf
hostonly="yes"
hostonly_cmdline="no"
compress="lz4"
omit_dracutmodules+=" brltty rpmversion selinux convertfs ssh-client "
force_drivers+=" i915 "
  
nano /etc/fstab
tmpfs                                           /tmp            tmpfs   defaults,nosuid,nodev   0       0
UUID= /boot ext4 defaults,relatime  0 2
UUID= /boot/efi vfat defaults,relatime 0 2
UUID= / btrfs defaults,noatime,compress=zstd:3  0 0
UUID= /home btrfs subvol=home,noatime 0 0
UUID= /.snapshots btrfs subvol=snapshots,noatime 0 0

xbps-install -S dbus-elogind dbus-elogind-libs elogind #dbus-elogind-x11 Optional

xbps-install -S intel-ucode rtkit dracut-uefi gummiboot-efistub bluez libbluetooth 

cp /usr/lib/gummiboot/linuxx64.efi.stub /boot/efi/
nano /etc/default/dracut-uefi-hook

sudo lsblk -f

KERNEL_CMDLINE="loglevel=3 rd.luks.name=<LUKS root UUID>=void root=UUID=<UUID> rd.luks.allow-discards rd.driver.pre=i915 udev.log_level=2 console=tty6 quiet splash"


xbps-install NetworkManager iwd
mkdir -p /etc/NetworkManager/conf.d/
nano /etc/NetworkManager/conf.d/wifi_backend.conf
[device]
wifi.backend=iwd
wifi.iwd.autoconnect=yes

nano /etc/iwd/main.conf
[General]
UseDefaultInterface=true
  
xbps-reconfigure -fa

exit
umount -R /mnt
shutdown -r now



